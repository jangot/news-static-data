<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>News Keywords</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <style>
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 16px;  /* Preferred icon size */
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;

            /* Support for all WebKit browsers. */
            -webkit-font-smoothing: antialiased;
            /* Support for Safari and Chrome. */
            text-rendering: optimizeLegibility;

            /* Support for Firefox. */
            -moz-osx-font-smoothing: grayscale;

            /* Support for IE. */
            font-feature-settings: 'liga';
        }
        .days-container {
            width: 100%;
            display: flex;
            overflow: scroll;
        }
        .day-item {
            flex: 0 0 400px;
            margin: 5px;
        }
    </style>
</head>
<body>
<h1>News Keywords</h1>
<div class="content">
    <div style="width: 500px;">
        <div class="input-group mb-3">
            <span class="input-group-text">From</span>
            <input type="date" class="form-control" id="date-start" aria-describedby="startDate">
            <span class="input-group-text">To</span>
            <input type="date" class="form-control" id="date-end" aria-describedby="endDate">
            <button type="button" class="btn btn-primary" id="apply-filter">Show</button>
        </div>
    </div>
    <div class="loading">Loading...</div>
    <div class="days-container">
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<script>
    const MIN_COUNT = 20;
    const LIMIT_COUNT = 20;
    const BASE_URL = 'https://raw.githubusercontent.com/jangot/news-static-data/main/data/ria';
    function loadDay(day) {
        const dataForDayUrl = `${BASE_URL}/${day}.json`;
        console.log(dataForDayUrl);

        return fetch(dataForDayUrl)
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`File [${day}] was not loaded: ${ response.statusText}`);
                }
                return response.json();
            })
            .then((data) => {
                return {
                    data,
                    link: dataForDayUrl
                };
            })
            .catch((error) => {
                console.error(error);
                return null;
            })
    }
    function isLimit(keyword, index) {
        return keyword.count < MIN_COUNT || index > LIMIT_COUNT;
    }

    $(() => {
        const currentState = new URLSearchParams(window.location.search);
        if (currentState.has('from')) {
            $('#date-start').val(currentState.get('from'));
        }
        if (currentState.has('to')) {
            $('#date-end').val(currentState.get('to'));
        }

        $('#apply-filter').click(() => {
            const start = $('#date-start').val();
            const end = $('#date-end').val();
            if (!start && !end) {
                return;
            }

            const search = new URLSearchParams();
            if (start) {
                search.set('from', start);
            }
            if (end) {
                search.set('to', end);
            }

            window.location.href = window.location.pathname + '?' + search.toString();
        });
    });

    $(async() => {
        const searchParams = new URLSearchParams(window.location.search);
        const lastDate = searchParams.has('to') ? moment(searchParams.get('to')) : moment().startOf('day');
        const currentDate = searchParams.has('from') ? moment(searchParams.get('from')) : moment(lastDate).startOf('day').add(-15, 'days');

        const container = $('.days-container');
        while (currentDate.isBefore(lastDate)) {
            const day = currentDate.format('YYYY-MM-DD');
            const dayList = await loadDay(day);
            if (dayList) {
                const html = dayList.data.keywords.map((keyword, index) => {
                    if (isLimit(keyword, index)) {
                        return '';
                    }
                    return `
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <a class="material-icons" href="https://www.google.com/search?q=${keyword.keyword}+${day}+новости" target="_blank">search</a>
                                ${keyword.keyword}
                            </div>
                            <span class="badge bg-primary rounded-pill">${keyword.count}</span>
                        </li>
                        `;
                });
                container.append(`
                    <div class="day-item">
                        <h3>
                            ${day}
                            <a class="text-muted" href="${dayList.link}" target="_blank">open file</a>
                        </h3>
                        <ul class="list-group">${html.join('')}</ul>
                    </div>
                `);
            }

            currentDate.add(1, 'days');
        }
        $('.loading').css('visibility', 'hidden');
    });
</script>
</body>
</html>
